// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql" // change if you use MySQL
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

// =========================================
// ENUMS
// =========================================

enum Role {
  admin
  manager
  employe
}

enum TimesheetStatus {
  normal
  delay
  absence
  incomplete
}

enum ScheduleTypes {
  equipe
  employe
  general
}

enum AbsenceType {
  conges_payes      // Congés payés
  conges_sans_solde // Congés sans solde
  maladie           // Arrêt maladie
  formation         // Formation
  teletravail       // Télétravail
  autre             // Autre raison
}

enum AbsenceStatus {
  en_attente  // En attente de validation
  approuve    // Approuvé par le manager
  refuse      // Refusé par le manager
  annule      // Annulé par l'employé
}



// =========================================
// MODELS
// =========================================

model User {
  id                 Int       @id @default(autoincrement())
  firstName          String    @db.VarChar(100)
  lastName           String    @db.VarChar(100)
  email              String    @unique @db.VarChar(255)
  phone              String    @db.VarChar(20) @default("")
  hashedPassword     String    @db.VarChar(255)
  role               Role      @default(employe)
  isActive           Boolean   @default(true)
  teamId             Int?
  managerId          Int?
  customScheduleId   Int?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @default(now())
  deletedAt          DateTime?
  lastLoginAt        DateTime? @default(now())


  // Relations
  team               Team?        @relation("TeamMembers",fields: [teamId], references: [id], onDelete: SetNull)
  mySchedules        Schedule[]   @relation("ManagerSchedules")
  manager            User?        @relation("UserManager", fields: [managerId], references: [id], onDelete: Cascade)
  employes           User[]       @relation("UserManager")
  managedTeams       Team[]       @relation("ManagerTeams")
  timesheets         Timesheet[]
  reports            Report[]     @relation("ReportManager")
  customSchedule     Schedule?    @relation("UserCustomSchedule", fields: [customScheduleId], references: [id], onDelete: SetNull)
  absences           Absence[]  @relation("EmployeAbsences")
  validatedAbsences  Absence[] @relation("ValidatorAbsences")

  @@index([email])
  @@index([role])
  @@index([teamId])
  @@index([customScheduleId]) 
}

model Team {
  id             Int       @id @default(autoincrement())
  name           String    @db.VarChar(100)
  description    String    @default("")
  managerId      Int
  scheduleId     Int?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @default(now())
  deletedAt      DateTime?

  // Relations
  manager        User      @relation("ManagerTeams", fields: [managerId], references: [id], onDelete: Restrict)
  schedule       Schedule? @relation("TeamSchedule", fields: [scheduleId], references: [id], onDelete: SetNull)
  members        User[]     @relation("TeamMembers")
  reports        Report[]

  @@index([managerId])
  @@index([scheduleId])
}

model Schedule {
  id           Int       @id @default(autoincrement())
  managerId    Int
  name         String    @db.VarChar(100)
  startHour    DateTime  @db.Time
  endHour      DateTime  @db.Time
  activeDays   Json
  typeSchedule ScheduleTypes
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @default(now())
  
  // Relations
  manager         User     @relation("ManagerSchedules", fields: [managerId], references: [id], onDelete: Restrict) 
  teams           Team[]   @relation("TeamSchedule")
  usersWithCustom User[]   @relation("UserCustomSchedule")

  // Index
  @@index([managerId])
}

model Timesheet {
  id           Int             @id @default(autoincrement())
  employeId    Int
  timestamp    DateTime
  clockin      Boolean
  status       TimesheetStatus  @default(normal)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @default(now())

  // Relations
  employe     User             @relation(fields: [employeId], references: [id], onDelete: Cascade)

  @@index([employeId])
  @@index([timestamp])
  @@index([status])
  @@index([employeId, timestamp])
}

model Absence {
  id              Int             @id @default(autoincrement())
  employeId       Int
  type            AbsenceType
  status          AbsenceStatus   @default(en_attente)
  startDateTime   DateTime
  endDateTime     DateTime
  isFullDay       Boolean         @default(false)
  validatedBy     Int?
  validatedAt     DateTime?
  comments        String?         @db.Text
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @default(now())
  deletedAt       DateTime?

  // Relations
  employe         User            @relation("EmployeAbsences", fields: [employeId], references: [id], onDelete: Cascade)
  validator       User?           @relation("ValidatorAbsences", fields: [validatedBy], references: [id], onDelete: SetNull)

  @@index([employeId])
  @@index([type])
  @@index([status])
  @@index([startDateTime, endDateTime])
  @@index([employeId, status])
}


model Report {
  id           Int       @id @default(autoincrement())
  managerId    Int?
  teamId       Int?
  periodStart  DateTime  @db.Date
  periodEnd    DateTime  @db.Date
  kpiType      String    @db.VarChar(50)
  value        Float
  metadata     Json?
  createdAt    DateTime  @default(now())

  // Relations
  manager      User?     @relation("ReportManager", fields: [managerId], references: [id], onDelete: SetNull)
  team         Team?     @relation(fields: [teamId], references: [id], onDelete: SetNull)

  @@index([managerId])
  @@index([teamId])
  @@index([kpiType])
  @@index([periodStart, periodEnd])
}
