# Application - DTOs & Mappers

## DTOs - Data Transfer Objects

### Philosophy
Transfer data between layers (Presentation ↔ Application).

**Principle:** Avoid `?` as much as possible. Use `| null` if Props defines it.

---

## DTO Types

### 1. ReadDTO (GET by ID)

**Format:** Based on `XEntityProps` (complete entity)

**Rules:**
- ✅ All **required** fields (no `?`)
- ✅ Use `| null` if Props defines it
- ✅ Relations in complete `_Core` format
- ✅ Dates → `string` (ISO 8601)

**Example:**
```typescript
// ✅ GOOD
export interface UserReadEmployeeDTO {
  id: number;
  firstName: string;
  lastName: string;
  email: string;
  phone: string;
  role: "employe";
  isActive: boolean;
  teamId: number | null;           // null because Props defines it
  managerId: number;
  customScheduleId: number | null;
  createdAt: string;
  updatedAt: string;
  lastLoginAt: string;
  deletedAt: string | null;

  // COMPLETE _Core relations
  manager: {
    id: number;
    firstName: string;
    lastName: string;
    email: string;
    phone: string;
    hashedPassword: string;
    role: Role;
    isActive: boolean;
  };

  team: {
    id: number;
    name: string;
    description: string | null;
    managerId: number;
    scheduleId: number | null;
    membersCount: number;
  } | null;
}
```

**Directive:** Read `XEntityProps`, include **ALL** `_Core` fields for relations.

---

### 2. ListItemDTO (GET list)

**Objective:** Reduced data for performance

**Rules:**
- ✅ Base fields only
- ✅ Relations = IDs only
- ✅ Optional calculated fields (e.g., `teamName`)

```typescript
export interface UserListItemDTO {
  id: number;
  firstName: string;
  lastName: string;
  email: string;
  role: Role;
  isActive: boolean;
  teamId: number | null;
  teamName: string | null; // For display
}
```

---

### 3. CreateDTO

**Rules:**
- ✅ Without id (generated by DB)
- ✅ Without timestamps (auto)
- ✅ `?` for optional creation fields

```typescript
export interface UserCreateEmployeeDTO {
  firstName: string;
  lastName: string;
  email: string;
  password: string;      // Before hashing
  role: Extract<Role, "employe">;
  phone?: string;        // ✅ Optional for creation
  teamId?: number;
  managerId: number;
  customScheduleId?: number;
}
```

---

### 4. UpdateDTO

**Rule:** **ALL** fields optional (partial PATCH)

```typescript
export interface UserUpdateDTO {
  firstName?: string;
  lastName?: string;
  email?: string;
  phone?: string;
  role?: Role;
  isActive?: boolean;
}

// ❌ Exclude: id, timestamps, hashedPassword, teamId (dedicated routes)
```

---

## Props ↔ DTOs Mapping

| Props Type | DTO Usage | Format |
|------------|-----------|--------|
| `XEntityProps_Core` | CreateDTO (without id) | Creation + List |
| `XEntityProps_L1` | - | (Internal) |
| `XEntityProps` | ReadDTO | GET by ID |
| - | UpdateDTO | PATCH (all `?`) |

---

## Anti-Patterns

### ❌ #1 - Excessive optional properties
```typescript
// ❌ BAD
name?: string;        // name never null in Props
manager?: {...};      // manager required in Props

// ✅ GOOD
name: string;
manager: {...};
```

### ❌ #2 - Incomplete relations
```typescript
// ❌ BAD
manager?: { id: number; firstName?: string; }

// ✅ GOOD - COMPLETE _Core format
manager: {
  id: number;
  firstName: string;
  lastName: string;
  email: string;
  phone: string;
  hashedPassword: string;
  role: Role;
  isActive: boolean;
}
```

### ❌ #3 - Optional/nullable confusion
```typescript
// ❌ BAD
description?: string | null;  // Double optionality
scheduleId?: number;          // Props says "| null"

// ✅ GOOD
description: string | null;
scheduleId: number | null;
```

---

## Claude Directive

### DTO creation/modification:

1. **ALWAYS** read Props before creation
2. **NEVER** use `?` except:
   - UpdateDTO (all optional)
   - CreateDTO (truly optional fields)
3. **ALWAYS** `| null` if Props defines it
4. **ALWAYS** include ALL `_Core` fields for relations
5. **NEVER** partial relations `{ id, name }`

**When in doubt:**
- "Optional?" → Consult Props
- "Complete relation?" → Check ALL `_Core` fields
- "`?` or `| null`?" → Props says `| null` → DTO too

---

## Mappers - Entity ↔ DTO Transformations

### Namespace Pattern

```
application/mappers/user/
├── index.ts                 # Centralized export
├── to-dto-core.mapper.ts   # Entity_Core → DTO_Core
├── to-dto-l1.mapper.ts     # Entity_L1 → DTO_L1
├── to-dto.mapper.ts        # Entity → DTO
├── from-dto.mapper.ts      # DTO → Entity
└── utils.mapper.ts         # Type guards
```

### Example

```typescript
// to-dto-core.mapper.ts
export namespace UserMapper {
  export class FromEntityCore {
    public static toReadDTO_Core(
      user: UserEmployee_Core | UserManager_Core
    ): UserReadEmployeeDTO_Core | UserReadManagerDTO_Core {
      if (UserMapperUtils.isUserEmployee(user)) {
        return this.toEmployeeReadDTO_Core(user);
      }
      return this.toManagerReadDTO_Core(user);
    }

    public static toEmployeeReadDTO_Core(
      employee: UserEmployee_Core
    ): UserReadEmployeeDTO_Core {
      const { hashedPassword, ...data } = employee;
      return { ...data };
    }
  }
}

// from-dto.mapper.ts
export namespace UserMapper {
  export class FromDTO {
    public static CreateEmployee_ToEntityCore(
      dto: UserCreateEmployeeDTO,
      hashedPassword: string,
      role: Extract<Role, "employe">
    ): UserEmployee_Core {
      return new UserEmployee_Core({
        id: 0,  // Généré Prisma
        ...dto,
        hashedPassword,
        isActive: true,
        teamId: dto.teamId ?? null,
        customScheduleId: null,
        role
      });
    }

    public static UpdateEmployee_ToEntity(
      existing: UserEmployee_Core,
      dto: UserUpdateDTO
    ): UserEmployee_Core {
      return new UserEmployee_Core({
        ...existing,
        firstName: dto.firstName ?? existing.firstName,
        // ... merge avec ??
      });
    }
  }
}
```

**Organization:**
- `FromEntity`: Entity → DTO
- `FromEntityCore`: Entity_Core → DTO_Core
- `FromDTO`: DTO → Entity

**Directive:** NEVER transform in controller/usecase - ALWAYS use Mapper.

---

## DTO Creation Checklist

1. ✅ Read `XEntityProps` in `domain/types/entityProps.ts`
2. ✅ Identify type: ReadDTO, ListItemDTO, CreateDTO, UpdateDTO
3. ✅ Apply rules:
   - ReadDTO → All required (except `| null`), complete _Core relations
   - ListItemDTO → Lightweight data, IDs only
   - CreateDTO → Without id/timestamps, `?` if optional
   - UpdateDTO → All `?`
4. ✅ Dates: `Date` → `string`
5. ✅ Relations: **Complete** `_Core` format

---

## Decision Tree

```
Which DTO?
│
├─ GET /entities/:id → ReadDTO
│  ├─ All required (except | null)
│  ├─ Complete _Core relations
│  └─ Dates → string
│
├─ GET /entities → ListItemDTO
│  ├─ Base fields
│  ├─ IDs only
│  └─ Performance
│
├─ POST /entities → CreateDTO
│  ├─ Without id, timestamps
│  ├─ ? if optional for creation
│  └─ password (not hashedPassword)
│
└─ PATCH /entities/:id → UpdateDTO
   ├─ ALL ?
   ├─ Without id, timestamps
   └─ Modifiable fields
```
